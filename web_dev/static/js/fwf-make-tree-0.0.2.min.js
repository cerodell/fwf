var redIcon=new L.Icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});const fwfmodellocation=L.marker([51.5,-.09],{icon:redIcon}).bindPopup("<b>Hello!</b><br />I am the closest model grid point to <br /> where you clicked or searched on the map."),fwfclicklocation=L.marker().bindPopup("<b>Hello!</b><br />I am where you clicked <br /> or searched on the map."),buffer=.05;var point_list=[],file_list=[];function makeplotly(e,t,n){for(var o=e.XLAT,r=e.XLONG,a=[],i=[],c=[(c=[o.length,o[0].length])[1],c[0]],l=0;l<o.length;l++)a=a.concat(o[l]);for(l=0;l<r.length;l++)i=i.concat(r[l]);var u=a.map(function(e,t){return[e,i[t]]}),s=new KDBush(u);point_list.push(t),file_list.push(e);var d=s.range(t[0]-buffer,t[1]-buffer,t[0]+buffer,t[1]+buffer).map(e=>u[e]);ll_diff=[],function(e,t){for(var n=0;n<e.length;n++){var o=Math.abs(e[n][0]-t[0])+Math.abs(e[n][1]-t[1]);ll_diff.push(o)}}(d,t);var h=0,m=ll_diff[0];for(l=1;l<ll_diff.length;l++)ll_diff[l]<m&&(m=ll_diff[l],h=l);var p,b,y=s.range(t[0]-buffer,t[1]-buffer,t[0]+buffer,t[1]+buffer);f=(b=(p=c).reduce(function(e,t){return e.concat(e[e.length-1]*t)},[1]),function(e){return t=e,n=b,p.map(function(e,o){return Math.round(t/n[o])%e});var t,n});var x=function(e,t){var n=e.reduce(function(e,t){return e.concat(e[e.length-1]*t)},[1]);return e.map(function(e,o){return Math.round(t/n[o])%e})}(c,y[h],f(y[h])),g=x[1],w=x[0],_=e.XLAT[g][w],k=e.XLONG[g][w],v=e.Time,F=e.Day,I=document.getElementById("plot_fwi"),T=e.FFMC.map(function(e,t){return e[g][w]}),M=e.ISI.map(function(e,t){return e[g][w]}),z=(e.FWI.map(function(e,t){return e[g][w]}),e.temp.map(function(e,t){return e[g][w]})),C=e.rh.map(function(e,t){return e[g][w]}),L=e.wsp.map(function(e,t){return e[g][w]}),j=e.wdir.map(function(e,t){return e[g][w]}),D=e.qpf.map(function(e,t){return e[g][w]}),S=e.DMC.map(function(e,t){return e[g][w]}),P=e.DC.map(function(e,t){return e[g][w]}),U=e.BUI.map(function(e,t){return e[g][w]}),W=e.FWI.map(function(e,t){return e[g][w]}),A=e.DSR.map(function(e,t){return e[g][w]}),N=[["DMC","DC","BUI","FWI","DSR"],[S[0],P[0],U[0],W[0],A[0]],[S[1],P[1],U[1],W[1],A[1]]],R=(T={x:v,y:T,type:"scatter",line:{color:"ff7f0e"},yaxis:"y7",name:"FFMC"},M={x:v,y:M,type:"scatter",line:{color:"9467bd"},yaxis:"y6",name:"ISI"},z={x:v,y:z,type:"scatter",line:{color:"d62728"},yaxis:"y5",name:"Temp (C)"},C={x:v,y:C,type:"scatter",line:{color:"1f77b4"},yaxis:"y4",name:"RH (%)"},L={x:v,y:L,type:"scatter",line:{color:"202020"},yaxis:"y3",name:"WSP (km/hr)"},j={x:v,y:j,type:"scatter",line:{color:"7f7f7f"},yaxis:"y2",name:"WDIR (deg)"},D={x:v,y:D,type:"scatter",line:{color:"2ca02c"},yaxis:"y1",name:"QPF (mm)"},[{type:"table",header:{values:[["<b>Index/Code</b>"],[F[0]],[F[1]]],align:"center",line:{width:1,color:"616161"},fill:{color:"7f7f7f"},font:{family:"inherit",size:12,color:"white"}},cells:{values:N,align:"center",line:{color:"616161",width:1},fill:{color:[["white","white","white","white","white"]]},font:{family:"inherit",size:11,color:["616161"]}},xaxis:"x",yaxis:"y",domain:{x:[0,1],y:[.8,1]}},T,M,C,z,L,j,D]),B={autosize:!0,title:"Fire Weather Forecast <br> Lat: "+_.toFixed(3)+", Long: "+k.toFixed(3),titlefont:{color:"#616161",autosize:!0},showlegend:!1,yaxis7:{domain:[.67,.78],title:{text:"FFMC",font:{color:"ff7f0e"}},tickfont:{color:"ff7f0e"}},yaxis6:{domain:[.56,.65],title:{text:"ISI",font:{color:"9467bd"}},tickfont:{color:"9467bd"}},yaxis5:{domain:[.45,.54],title:{text:"Temp<br>(C)",font:{color:"d62728"}},tickfont:{color:"d62728"}},yaxis4:{domain:[.34,.43],title:{text:"RH<br>(%)",font:{color:"1f77b4"}},tickfont:{color:"1f77b4"}},yaxis3:{domain:[.23,.32],title:{text:"WSP<br>(km/hr)",font:{color:"202020"}},tickfont:{color:"202020"}},yaxis2:{domain:[.12,.21],title:{text:"WDIR<br>(deg)",font:{color:"7f7f7f"}},tickfont:{color:"7f7f7f"},range:[0,360],tickvals:[0,90,180,270,360]},yaxis1:{domain:[0,.09],title:{text:"QPF<br>(mm)",font:{color:"2ca02c"}},tickfont:{color:"2ca02c"}},xaxis:{title:"Date (UTC)"},shapes:[{type:"line",x0:n,y0:0,x1:n,yref:"paper",y1:.8,line:{color:"grey",width:1.5,dash:"dot"}},{type:"rect",xref:"x",yref:"paper",x0:tinital,y0:0,x1:UTCTimePlot,y1:.8,fillcolor:"#A7A7A7",opacity:.2,line:{width:0}}]};fwfmodellocation.setLatLng([_.toFixed(3),k.toFixed(3)]).addTo(map),Plotly.react(I,R,B)}function makeplots(e){json_dir="fwf-zone.json",fetch(e).then(function(e){return e.json()}).then(function(e){var t=[50.6599,-120.3552];fwfclicklocation.setLatLng(t).addTo(map),makeplotly(e,t,UTCTimeMap)}),fetch(json_dir,{cache:"default"}).then(function(e){return e.json()}).then(function(t){for(var n=t.ZONE,o=t.XLAT,r=t.XLONG,a=[],i=[],c=[(c=[o.length,o[0].length])[1],c[0]],l=0;l<o.length;l++)a=a.concat(o[l]);for(l=0;l<r.length;l++)i=i.concat(r[l]);a=a.map(Number),i=i.map(Number);var u=a.map(function(e,t){return[e,i[t]]});const s=new KDBush(u);loaded_zones=["he"],map.on("click",function(t){fwfclicklocation.setLatLng(t.latlng).addTo(map);var o=[parseFloat(t.latlng.lat.toFixed(4)),parseFloat(t.latlng.lng.toFixed(4))];const r=s.range(o[0]-buffer,o[1]-buffer,o[0]+buffer,o[1]+buffer).map(e=>u[e]);ll_diff=[],function(e,t){for(var n=0;n<e.length;n++){var o=Math.abs(e[n][0]-t[0])+Math.abs(e[n][1]-t[1]);ll_diff.push(o)}}(r,o);for(var a=0,i=ll_diff[0],l=1;l<ll_diff.length;l++)ll_diff[l]<i&&(i=ll_diff[l],a=l);const d=s.range(o[0]-buffer,o[1]-buffer,o[0]+buffer,o[1]+buffer);var h,m;f=(m=(h=c).reduce(function(e,t){return e.concat(e[e.length-1]*t)},[1]),function(e){return t=e,n=m,h.map(function(e,o){return Math.round(t/n[o])%e});var t,n});var p=function(e,t){var n=e.reduce(function(e,t){return e.concat(e[e.length-1]*t)},[1]);return e.map(function(e,o){return Math.round(t/n[o])%e})}(c,d[a],f(d[a])),b=p[1],y=p[0],x=n[b][y];zone_json=e.slice(0,14),zone_json=zone_json+x+e.slice(16,32),fetch(zone_json).then(function(e){return e.json()}).then(function(e){makeplotly(e,o,UTCTimeMap)}),loaded_zones.push(x)});var d=new(createSearchboxControl())({sidebarTitleText:"Information",sidebarMenuItems:{Items:[{type:"link",name:"Smoke Forecasts",href:"https://firesmoke.ca/",icon:"icon-fire"},{type:"link",name:"Weather Research Forecast Team",href:"https://weather.eos.ubc.ca/cgi-bin/index.cgi",icon:"icon-cloudy"},{type:"link",name:"Contact Inforamtion",href:"https://firesmoke.ca/contact/",icon:"icon-phone"},{type:"link",name:"Documentation",href:"https://cerodell.github.io/fwf-docs/index.html",icon:"icon-git"}]}});d._searchfunctionCallBack=function(t){t||(t="The search call back is clicked !!"),function(t){map.flyTo(t),fwfclicklocation.setLatLng(t).addTo(map);var o=[parseFloat(t[0]),parseFloat(t[1])],r=s.range(o[0]-buffer,o[1]-buffer,o[0]+buffer,o[1]+buffer).map(e=>u[e]);ll_diff=[],function(e,t){for(var n=0;n<e.length;n++){var o=Math.abs(e[n][0]-t[0])+Math.abs(e[n][1]-t[1]);ll_diff.push(o)}}(r,o);for(var a=0,i=ll_diff[0],l=1;l<ll_diff.length;l++)ll_diff[l]<i&&(i=ll_diff[l],a=l);var d,h,m=s.range(o[0]-buffer,o[1]-buffer,o[0]+buffer,o[1]+buffer);f=(h=(d=c).reduce(function(e,t){return e.concat(e[e.length-1]*t)},[1]),function(e){return t=e,n=h,d.map(function(e,o){return Math.round(t/n[o])%e});var t,n});var p=function(e,t){var n=e.reduce(function(e,t){return e.concat(e[e.length-1]*t)},[1]);return e.map(function(e,o){return Math.round(t/n[o])%e})}(c,m[a],f(m[a])),b=p[1],y=p[0],x=n[b][y];zone_json=e.slice(0,14),zone_json=zone_json+x+e.slice(16,32),fetch(zone_json).then(function(e){return e.json()}).then(function(e){makeplotly(e,o,UTCTimeMap)}),loaded_zones.push(x)}(t.split(",").map(Number))},map.addControl(d)}),window.onresize=function(){Plotly.Plots.resize(plot_fwi)}}window.onload=function(){makeplots(json_fwf)};
