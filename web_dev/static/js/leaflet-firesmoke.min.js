L.TimeDimension.Layer.ImageOverlay=L.TimeDimension.Layer.extend({initialize:function(b,a){L.TimeDimension.Layer.prototype.initialize.call(this,b,a);this._layers={};this._defaultTime=0;this._timeCacheBackward=this.options.cacheBackward||this.options.cache||0;this._timeCacheForward=this.options.cacheForward||this.options.cache||0;this._getUrlFunction=this.options.getUrlFunction;this._baseLayer.on("load",(function(){this._baseLayer.setLoaded(true);this.fire("timeload",{time:this._defaultTime})}).bind(this))},eachLayer:function(c,a){for(var b in this._layers){if(this._layers.hasOwnProperty(b)){c.call(a,this._layers[b])}}return L.TimeDimension.Layer.prototype.eachLayer.call(this,c,a)},_onNewTimeLoading:function(b){var a=this._getLayerForTime(b.time);if(!this._map.hasLayer(a)){this._map.addLayer(a)}},isReady:function(b){var a=this._getLayerForTime(b);return a.isLoaded()},_update:function(){if(!this._map){return}var b=map.timeDimension.getCurrentTime();var a=this._getLayerForTime(b);if(this._currentLayer==null){this._currentLayer=a}if(!this._map.hasLayer(a)){this._map.addLayer(a)}else{this._showLayer(a,b)}},_showLayer:function(d,e){if(this._currentLayer&&this._currentLayer!==d){this._currentLayer.hide();this._map.removeLayer(this._currentLayer)}d.show();if(this._currentLayer&&this._currentLayer===d){return}this._currentLayer=d;var f=this._getLoadedTimes();var g=String(e);var c=f.indexOf(g);var a=[];if(this._timeCacheBackward>-1){var b=c-this._timeCacheBackward;if(b>0){a=f.splice(0,b);this._removeLayers(a)}}if(this._timeCacheForward>-1){c=f.indexOf(g);var b=f.length-c-this._timeCacheForward-1;if(b>0){a=f.splice(c+this._timeCacheForward+1,b);this._removeLayers(a)}}},_getLayerForTime:function(c){if(c==0||c==this._defaultTime){return this._baseLayer}if(this._layers.hasOwnProperty(c)){return this._layers[c]}var a=this._getUrlFunction(this._baseLayer.getURL(),c);imageBounds=this._baseLayer._bounds;var b=L.imageOverlay(a,imageBounds,this._baseLayer.options);this._layers[c]=b;b.on("load",(function(d,e){d.setLoaded(true);if(map.timeDimension&&e==map.timeDimension.getCurrentTime()&&!map.timeDimension.isLoading()){this._showLayer(d,e)}this.fire("timeload",{time:e})}).bind(this,b,c));b.onAdd=(function(d){Object.getPrototypeOf(this).onAdd.call(this,d);this.hide()}).bind(b);return b},_getLoadedTimes:function(){var a=[];for(var b in this._layers){if(this._layers.hasOwnProperty(b)){a.push(b)}}return a.sort()},_removeLayers:function(c){for(var b=0,a=c.length;b<a;b++){this._map.removeLayer(this._layers[c[b]]);delete this._layers[c[b]]}}});L.timeDimension.layer.imageOverlay=function(b,a){return new L.TimeDimension.Layer.ImageOverlay(b,a)};L.ImageOverlay.include({_visible:true,_loaded:false,_originalUpdate:L.imageOverlay.prototype._update,_update:function(){if(!this._visible&&this._loaded){return}this._originalUpdate()},setLoaded:function(a){this._loaded=a},isLoaded:function(){return this._loaded},hide:function(){this._visible=false;if(this._image&&this._image.style){this._image.style.display="none"}},show:function(){this._visible=true;if(this._image&&this._image.style){this._image.style.display="block"}},getURL:function(){return this._url}});pad2=function(a){return a<10?"0"+a:a};dateFileName=function(a){YYYYMMDD=a.getUTCFullYear().toString();YYYYMMDD+=pad2(a.getUTCMonth()+1).toString();YYYYMMDD+=pad2(a.getUTCDate()).toString();return YYYYMMDD};dateTimeFileName=function(a){YYYYMMDDhhmm=a.getUTCFullYear().toString();YYYYMMDDhhmm+=pad2(a.getUTCMonth()+1).toString();YYYYMMDDhhmm+=pad2(a.getUTCDate()).toString();YYYYMMDDhhmm+=pad2(a.getUTCHours()).toString();YYYYMMDDhhmm+=pad2(a.getUTCMinutes()).toString();return YYYYMMDDhhmm};getForecastImageUrl=function(c,d){var b=c.substring(0,c.lastIndexOf("/"));var a=c.substring(c.lastIndexOf("/"),c.length-16);var e=dateTimeFileName(new Date(d));url=b+a+e+".png";return url};getDailyForecastImageUrl=function(c,d){var b=c.substring(0,c.lastIndexOf("/"));var a=c.substring(c.lastIndexOf("/"),c.length-12);var e=dateFileName(new Date(d));url=b+a+e+".png";return url};
